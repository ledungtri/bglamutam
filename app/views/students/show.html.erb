<h1>Sơ Yếu Lý Lịch</h1>


<p style="margin: 10px"></p>
<fieldset>
  <legend><h3>Thông Tin Cá Nhân</h3></legend>
    <div>
      <div class="label">Tên Thánh - Họ và Tên:</div>
      <strong><%= @student.name %></strong>
    </div>
    
    <div>
      <div class="label">Giới Tính:</div>
      <strong><%= @student.gender %></strong>
    </div>
  
    <div>
      <div class="label">Ngày Sinh:</div>
      <strong><%= @student.date_birth&.strftime("%d-%m-%Y") %></strong>
      <% if @student.place_birth? %>
        <div style="display: inline-block; width: 30px; text-align: center">tại</div>
        <strong><%= @student.place_birth %></strong>
      <% end %>
    </div>
    
    <div>
      <div class="label">Điện Thoại Cá Nhân:</div>
      <strong><%= @student.phone %></strong>
    </div>
</fieldset>

<p style="margin: 10px"></p>
  
<fieldset>
  <legend><h3>Ngày Bí Tích</h3></legend>

    <div>
      <div class="label">Rửa Tội:</div>
      <strong><%= @student.date_baptism.strftime("%d-%m-%Y") if @student.date_baptism? %></strong>
      <% if @student.place_baptism? %>
        <div style="display: inline-block; width: 30px; text-align: center">tại</div>
        <strong><%= @student.place_baptism %></strong>
      <% end %>
    </div>
    
    <div>
      <div class="label">Rước Lễ:</div>
      <strong><%= @student.date_communion.strftime("%d-%m-%Y") if @student.date_communion? %></strong>
      <% if @student.place_communion? %>
        <div style="display: inline-block; width: 30px; text-align: center">tại</div>
        <strong><%= @student.place_communion %></strong>
      <% end %>
    </div>
    
    <div>
      <div class="label">Thêm Sức:</div>
      <strong><%= @student.date_confirmation.strftime("%d-%m-%Y") if @student.date_confirmation? %></strong>
      <% if @student.place_confirmation? %>
        <div style="display: inline-block; width: 30px; text-align: center">tại</div>
        <strong><%= @student.place_confirmation %></strong>
      <% end %>
    </div>
    
    <div>
      <div class="label">Tuyên Hứa:</div>
      <strong><%= @student.date_declaration.strftime("%d-%m-%Y") if @student.date_declaration? %></strong>
      <% if @student.place_declaration? %>
        <div style="display: inline-block; width: 30px; text-align: center">tại</div>
        <strong><%= @student.place_declaration %></strong>
      <% end %>
    </div>
</fieldset>

<p style="margin: 10px"></p>

<fieldset>
  <legend><h3>Địa Chỉ Nhà</h3></legend>
  
  <div>
    <div class="label">Địa Chỉ:</div>
    <strong><%= @student.address %></strong>
  </div>
  <div>
    <div class="label">Xóm Giáo:</div>
    <strong><%= @student.area %></strong>
  </div>
</fieldset>

<p style="margin: 10px"></p>

<fieldset>
  <legend><h3>Thông Tin Cha Mẹ</h3></legend>
    <div>
      <div class="label">Tên Thánh - Họ và Tên Cha:</div>
      <strong><%= @student.father_name %></strong>
    </div>

    <div>
      <div class="label">Điện Thoại Cha:</div>
      <strong><%= @student.father_phone %></strong>
    </div>      
    
    <div>
      <div class="label">Tên Thánh - Họ và Tên Mẹ:</div>
      <strong><%= @student.mother_name %></strong>
    </div>

    <div>
      <div class="label">Điện Thoại Mẹ:</div>
      <strong><%= @student.mother_phone %></strong> 
    </div>
</fieldset>

<% if @current_user&.admin_or_teacher_of_student?(@student) %>
  <%= button_to 'Chỉnh Sửa', edit_student_path(@student), method: :get, :class => "button" %>
<% end %>
<%= button_to "In Sơ Yếu Lý Lịch", student_path(format: "pdf"), method: :get, :class => "button" %>

<div class="divider"></div> 

<h1>Hành Trình Thiêng Liêng</h1>

<table>
  <thead>
    <tr>
      <th style="width: 200px; font-size: 18px">Năm Học</th>
      <th style="width: 200px; font-size: 18px">Lớp</th>
      <th style="width: 200px; font-size: 18px">Kết Quả</th>
    </tr>
  </thead>
  <tbody>
    <% @student.classrooms.sort_by {|classroom| classroom.year}.each do |classroom| %>
    <tr class="table-row">
      <td style="width: 200px; font-size: 14px"><%= classroom.long_year %></td>
      <td style="width: 200px; font-size: 14px"><%= link_to classroom.name, classroom %></td>
      <td style="width: 200px; font-size: 14px"><%= link_to @student.result(classroom), edit_enrollment_path(Enrollment.where(student_id: @student.id, classroom_id: classroom.id).take.id) %></td>
    </tr>
    <% end %>
    
    <tr class="table-row">
      <td id="form" style="display: none" colspan="3">
        <% @enrollment = Enrollment.new %>
        <%= form_for(@enrollment) do |f| %>
          <% if @enrollment.errors.any? %>
            <div id="error_explanation">
              <h2><%= pluralize(@enrollment.errors.count, "error") %> prohibited this enrollment from being saved:</h2>

              <ul>
              <% @enrollment.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
              </ul>
            </div>
          <% end %>
          <select id="year_combobox" onchange="changeClassroom()">
            <% @years.each do |year| %>
              <option value="<%=year%>"><%= year.to_s + " - " + (year.to_i+1).to_s %></option>
            <% end %>
          </select>
          <%= f.hidden_field :student_id, :value => @student.id %>
          <%= f.hidden_field :result, :value => "Đang Học" %>
          <%= f.select :classroom_id, options_for_select(@opts), :id => 'classroom_id' %>
          <%= f.submit "Thêm Lớp Mới" %>
        <% end %>
      </td>
    </tr>
  </tbody>
</table>

<% if @current_user&.admin? %>
  <button id="btn" onClick="showForm()" class="button">Thêm Lớp Mới</button>
<% end %>

<script>
  function showForm() {
    document.getElementById("btn").style.display = "none";
    document.getElementById("form").style.display = "table-cell";
  }
  
  function changeClassroom() {
    const e = document.getElementById("year_combobox");
    const selected = e.options[e.selectedIndex].value;

    //Create array of options to be added
    const hash = {};
    const keys = [];

    <% Classroom.where.not(family: ['Trưởng Ban', 'Kỹ Thuật']).sort_by(&:sort_param).each do |classroom| %>
    if(selected === "<%= classroom.year %>") {
      hash[<%= classroom.id %>] = "<%= classroom.name %>";
      keys.push(<%= classroom.id %>);
    }
    <% end %>

    const list = document.getElementById("enrollment_classroom_id");
    list.options.length = 0;
    
    //Create and append the options
    for (let i = 0; i < keys.length; i++) {
      const option = document.createElement("option");
      option.value = keys[i];
      option.text = hash[keys[i]];
      list.appendChild(option);
    }
  }
</script>
